name: Deploy CodeLabs to GCP VM (Docker CI/CD)

# TRIGGER: When code is pushed to main branch
on:
  push:
    branches: [main]
  workflow_dispatch: # NEW: Allows manual trigger from GitHub UI
# GLOBAL VARIABLES: Available to all jobs
env:
  FRONTEND_IMAGE: amantiwari001/codelabs-frontend
  BACKEND_IMAGE: amantiwari001/codelabs-backend

jobs:
  # =============================================
  # JOB 1: BUILD AND PUSH DOCKER IMAGES
  # =============================================
  # Build Docker images and push to Docker Hub
  # WHY: Images are portable, no need to install Node/npm on VM
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      # STEP 1: Get code from repo
      # KEPT: Same as before, need source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Docker Buildx
      # WHY: Enables build caching, faster subsequent builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build and push Frontend image
      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./front-end
          file: ./front-end/dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          # latest = easy to pull, sha = enables rollback
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Caches layers, 2nd build is much faster
          build-args: |
            VITE_SERVER_URL=${{ secrets.VITE_SERVER_URL }}
            VITE_AUTH0_DOMAIN=${{ secrets.VITE_AUTH0_DOMAIN }}
            VITE_AUTH0_CLIENT_ID=${{ secrets.VITE_AUTH0_CLIENT_ID }}
            VITE_REDIRECT_URI=${{ secrets.VITE_REDIRECT_URI }}

      # Build and push Backend image
      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./back-end
          file: ./back-end/dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================
  # JOB 2: DEPLOY TO GCP VM
  # =============================================
  deploy:
    name: Deploy to GCP VM
    needs: build-and-push # Wait for images to be ready
    runs-on: ubuntu-latest

    steps:
      # Get compose file to copy to VM
      - name: Checkout code
        uses: actions/checkout@v4

      # Copy docker-compose file to VM
      - name: Copy docker-compose to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'docker-compose.yaml'
          target: '~/codelabs'

      # CHANGED: Complete rewrite of SSH deployment script
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit immediately if any command fails

            echo "üöÄ Starting deployment..."
            cd ~/codelabs

            # Login to Docker Hub
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # Pull latest images (fast - only downloads changed layers, pre-built images)
            echo "üì• Pulling latest images..."
            docker compose pull

            # Stop old containers
            echo "üõë Stopping old containers..."
            docker compose down || true

            # Start new containers
            echo "‚úÖ Starting new containers..."
            docker compose up -d

            # Show status
            echo "üìä Container status:"
            docker compose ps

            # Cleanup old images
            echo "üßπ Cleaning up..."
            docker image prune -f

            echo "üéâ Deployment complete!"
